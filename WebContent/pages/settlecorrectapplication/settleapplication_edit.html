<!DOCTYPE html>
<html>
<head>
<title>结算审批修改-新增编辑</title>
<#include "../include/header.html">
<style type="text/css">
    tbody .form-group {
        margin-bottom: 0px;
    }
    .container{width:100% !important};
    .form-group {
        line-height: 34px !important;
        vertical-align: middle !important;
    }
    .row {line-height: 34px;vertical-align: middle;width:1000px;margin-left:0;margin-right:0;}
    .form-group label {
        max-width: 120px;
    }
    textarea {
        width: 710px !important;
    }
</style>
</head>
<body>
<div class="container">
    <form id="defaultForm">
        <input type="hidden" name="id" value="${(record.id)!}">
        <div class="row" >
            <div class="form-group"></div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="plan_no">计划号：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="plan_no" type="text" placeholder="" name="plan_no" value="${(record.plan_no)!}"/>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="consignor">托运人：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="consignor" type="text" placeholder="" name="consignor" value="${(record.consignor)!}" readonly="readonly"/>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="ship_name">船名：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="ship_name" type="text" placeholder="" name="ship_name" value="${(record.ship_name)!}"/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="ship_owner_name">姓名：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="ship_owner_name" type="text" placeholder="" name="ship_owner_name" value="${(record.ship_owner_name)!}" readonly="readonly"/>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="ship_owner_phone">手机号码：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="ship_owner_phone" type="text" placeholder="" name="ship_owner_phone" value="${(record.ship_owner_phone)!}" readonly="readonly"/>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="goods_name">货物名称：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="goods_name" type="text" placeholder="" name="goods_name" value="${(record.goods_name)!}" readonly="readonly"/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="seagoing_vessel_name">海轮名：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="seagoing_vessel_name" type="text" placeholder="" name="seagoing_vessel_name" value="${(record.seagoing_vessel_name)!}" readonly="readonly"/>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="freight_begin_end">运输起讫：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="freight_begin_end" type="text" placeholder="" name="freight_begin_end" value="${(record.freight_begin_end)!}" />
                </div>
            </div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="loading_tonnage">实装吨位：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="loading_tonnage" type="text" placeholder="" name="loading_tonnage" value="${(record.loading_tonnage)!}" readonly="readonly"/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="adjust_freight">调整运费：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="adjust_freight" type="text" placeholder="" name="adjust_freight" value="${(record.adjust_freight)!}"/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="reason">申请事由：</label>
                <div class="col-xs-8">
                    <textarea rows="3" class="form-control" name="reason" id="reason">${(record.reason)!}</textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group ">
                <label class="col-xs-2 control-label text-right" for="remark">备注：</label>
                <div class="col-xs-8">
                    <textarea rows="3" class="form-control" name="remark" id="remark">${(record.remark)!}</textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group">
                <label class="col-xs-2 control-label" for="v5"></label>
                <div class="col-xs-2 ">
                    <button type="submit" class="btn btn-11" id="save">　保存　</button>
                </div>
            </div>
        </div>
    </form>
</div>


<script>
//表单校验
$('#defaultForm').bootstrapValidator({
    message: 'This value is not valid',
    feedbackIcons: {   
        /* valid: 'glyphicon glyphicon-ok',
        invalid: 'glyphicon glyphicon-remove',
        validating: 'glyphicon glyphicon-refresh' */
    },
    fields: {
        plan_no: {
            validators: {
            	notEmpty:{
                    message: '不能为空!'
                },         	
                regexp: {
                    regexp: /^[0-9]+$/,
                    message: '请输入正确计划号'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        consignor: {
            validators: {
                regexp: {
                    regexp: /^[a-zA-Z0-9_\s\u0391-\uFFE5]+$/,
                    message: '不能包含特殊字符'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        ship_name: {
            validators: {
            	notEmpty:{
                    message: '不能为空!'
                },
            	regexp: {
                    regexp: /^[a-zA-Z0-9_\s\u0391-\uFFE5]+$/,
                    message: '不能包含特殊字符'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        ship_owner_name: {
            validators: {
                regexp: {
                    regexp: /^[a-zA-Z0-9_\s\u0391-\uFFE5]+$/,
                    message: '不能包含特殊字符'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        ship_owner_phone: {
            validators: {
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        goods_name: {
            validators: {
                regexp: {
                    regexp: /^[a-zA-Z0-9_\s\u0391-\uFFE5]+$/,
                    message: '不能包含特殊字符'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        seagoing_vessel_name: {
            validators: {
                regexp: {
                    regexp: /^[a-zA-Z0-9_\s\u0391-\uFFE5]+$/,
                    message: '不能包含特殊字符'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        freight_begin_end: {
            validators: {
                regexp: {
                    regexp: /^[a-zA-Z0-9_\s\u0391-\uFFE5]+$/,
                    message: '不能包含特殊字符'
                }, 
                stringLength: {
                    min: 0,
                    max: 50,
                    message: '不能超过 50 个字符',
                }
            }
        },
        loading_tonnage: {
            validators: {
                regexp: {
                	regexp: /^[0-9]+(\.[0-9]{1,3})?$/,
                    message: '请输入正确的数量'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        adjust_freight: {
            validators: {
                regexp: {
                    regexp: /^[0-9]+(\.[0-9]{1,2})?$/,
                    message: '请输入正确的调整运费'
                }, 
                notEmpty: {
					message: '请输入调整运费!'
				},
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        reason: {
            validators: {
                stringLength: {
                    min: 0,
                    max: 100,
                    message: '不能超过 100 个字符',
                }
            }
        },
        remark: {
            validators: {
                stringLength: {
                    min: 0,
                    max: 100,
                    message: '不能超过 100 个字符',
                }
            }
        },
    },
})
.on('success.form.bv', function(e) {
    e.preventDefault();
    var postData = $('form').serialize();
    $.post("/settlecorrect/app/save", postData, function(result) {
        if (result.code == 1) {
            parent.layer.msg(result.msg, {time: 2000}, function(){
            	websocket.send("提示");
                layer_close();
                parent.parent.refresh_iframe();
            });

        } else {
            parent.layer.msg(result.msg, {time: 2000});
        }
    });

});

// 根据计划号获取相关信息
$('#plan_no').on('change', function () {
	var postData = {
			plan_no: $.trim($(this).val())
	}
	$.post('/settlecorrect/app/getInfoByPlanNo', postData, function (result) {
		if (result.code == 1) {
		    var data = result.data;
		    $('#consignor').val(data.consignor);
		    $('#goods_name').val(data.goods_name);
		    $('#seagoing_vessel_name').val(data.seagoing_vessel_name);
		    //$('#freight_begin_end').val(data.delivery_dock + "到" + data.destination_port);
        } else {
            
        }
	})
	
});

// 根据船名获取相关信息
$('#ship_name').on('change', function () {
    var postData = {
    		ship_name: $.trim($(this).val()),
    		plan_no: $.trim($('#plan_no').val())
    }
    $.post('/settlecorrect/app/getInfoByShipName', postData, function (result) {
        if (result.code == 1) {
            var data = result.data;
            //console.log(data);
            $('#ship_owner_name').val(data.ship_owner_name);
            $('#ship_owner_phone').val(data.ship_owner_phone);
            $('#loading_tonnage').val(data.loading_tonnage);
        } else {
            
        }
    })
    
});

// input textarea 输入完成后，去除前后空格
$('input, textarea').on('change', function () {
	$(this).val($.trim($(this).val()));
})


 var websocket = null;
  //判断当前浏览器是否支持WebSocket
  if ('WebSocket' in window) {
      websocket = new WebSocket("ws://localhost:8080/websocket");
  }
  else {
      alert('当前浏览器 Not support websocket')
  }

  //连接发生错误的回调方法
  websocket.onerror = function () {
      
  };

  //连接成功建立的回调方法
  websocket.onopen = function () {
      //TODO用户登录系统检查属于自己的提醒消息
  }
  
  //连接关闭的回调方法
  websocket.onclose = function () {
      
  }

  //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
  window.onbeforeunload = function () {
      closeWebSocket();
  }

  //关闭WebSocket连接
  function closeWebSocket() {
      websocket.close();
  }

    
</script>
</body>
</html>