<!DOCTYPE html>
<html>
<head>
<title>客户运费结算清单-编辑</title>
<#include "../include/header.html">
<style type="text/css">
    tbody .form-group {
        margin-bottom: 0px;
    }
    .container{width:100% !important};
    .form-group {
        line-height: 34px !important;
        vertical-align: middle !important;
    }
    .row {vertical-align: middle;width:1100px;margin-left:0;margin-right:0;font-size:12px}
</style>
</head>
<body>
<div class="container">
    <form id="defaultForm">
        <input type="hidden" name="id" value="${(record.id)!}">
        <div class="row" >
            <div class="form-group"></div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="plan_no">计划号：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="plan_no" type="text" placeholder="" value="${(record.plan_no)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="">客户名称：</label>
                <div class="col-xs-5">
                    <input class="form-control text-left" id="consignor" type="text" placeholder=""  value="${(record.consignor)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="delivery_date">货物名称：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="delivery_date" type="text" placeholder="" value="${(record.goods_name)!}" readonly/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="estimated_arrvial_date">发货日期：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="estimated_arrvial_date" type="text" placeholder="" value="${(record.estimated_arrvial_date)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="delivery_dock">发货港：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="delivery_dock" type="text" placeholder="" value="${(record.delivery_dock)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="destination_port">目的港：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="destination_port" type="text" placeholder="" value="${(record.destination_port)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="ship_name">船名：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="ship_name" type="text" placeholder="" value="${(record.ship_name)!}" readonly/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="delivery_quantity">发货数量：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="delivery_quantity" type="text" placeholder="" value="${(record.delivery_quantity)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="received_quantity">卸货数量：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="received_quantity" type="text" placeholder="" value="${(record.received_quantity)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="loss">损耗：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="loss" type="text" placeholder="" value="${(record.loss)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="fixed_loss">定耗：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="fixed_loss" type="text" placeholder="" value="${(record.fixed_loss)!}" readonly/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="exceed_loss">超耗：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="exceed_loss" type="text" placeholder="" value="${(record.exceed_loss)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="deduct_price">扣价：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="deduct_price" type="text" placeholder="" value="${(record.deduct_price)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="deduct_money">扣款：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="deduct_money" type="text" placeholder="" value="${(record.deduct_money)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="freight_price">运价：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="freight_price" type="text" placeholder="" value="${(record.freight_price)!}" readonly/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="ship_freight">运费：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="ship_freight" type="text" placeholder="" value="${(record.ship_freight)!}" readonly/>
                </div>
            </div>       
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="rainy_days">雨天：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="rainy_days" type="text" placeholder="" value="${(record.rainy_days)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="declare_date">到港日期：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="declare_date" type="text" placeholder="" value="${(record.declare_date)!}" readonly/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="unloaded_date">卸空日期：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="unloaded_date" type="text" placeholder="" value="${(record.unloaded_date)!}" readonly/>
                </div>
            </div>
        </div>
                <div class="row">
         <div class="form-group"></div>
        <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="other_charges">开票：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="rainy_days" type="text" placeholder="" name="other_charges" value="${(record.billing?string('是', '否'))!}" readonly="readonly"/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="other_charges">保险：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="rainy_days" type="text" placeholder="" name="other_charges" value="${(record.insurance?string('是', '否'))!}" readonly="readonly"/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="other_charges">港建：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="rainy_days" type="text" placeholder="" name="other_charges" value="${(record.port_fee?string('是', '否'))!}" readonly="readonly"/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="port_construction_fee">港建费：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="port_construction_fee" type="text" placeholder="" name="port_construction_fee" value="${(record.port_construction_fee)!}"/>
                </div>
            </div>
        </div> 
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="extended_days">超期：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="extended_days" type="text" placeholder="" name="extended_days" value="${(record.extended_days)!}"/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="demurrage_charges">滞期费：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="demurrage_charges" type="text" placeholder="" name="demurrage_charges" value="${(record.demurrage_charges)!}"/>
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="other_charges">其他费用：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="rainy_days" type="text" placeholder="" name="other_charges" value="${(record.other_charges)!}" />
                </div>
            </div>
            <div class="form-group form-group-sm">
                <label class="col-xs-1 control-label text-right" for="payable_amount">应收费用：</label>
                <div class="col-xs-2">
                    <input class="form-control text-left" id="payable_amount" type="text" placeholder="" name="payable_amount" value="${(record.payable_amount)!}" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group"></div>
            <div class="form-group">
	            <label class="col-xs-1 control-label" for="v5"></label>
	            <div class="col-xs-2 ">
	                <button type="submit" class="btn btn-11" id="save">　保存　</button>
	            </div>
	        </div>
        </div>
    </form>
</div>


<script>
//表单校验
$('#defaultForm').bootstrapValidator({
    message: 'This value is not valid',
    feedbackIcons: {
        /* valid: 'glyphicon glyphicon-ok',
        invalid: 'glyphicon glyphicon-remove',
        validating: 'glyphicon glyphicon-refresh' */
    },
    fields: {

    	port_construction_fee: {
            validators: {
                regexp: {
                    regexp: /^[0-9]+(\.[0-9]{1,2})?$/,
                    message: '请输入正确的金额'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        extended_days: {
            validators: {
                regexp: {
                    regexp: /^\d+$/,
                    message: '请输入正确的天数'
                }, 
                stringLength: {
                    min: 0,
                    max: 3,
                    message: '不能超过 3 个字符',
                }
            }
        },
        demurrage_charges: {
            validators: {
                regexp: {
                    regexp: /^[0-9]+(\.[0-9]{1,2})?$/,
                    message: '请输入正确的金额'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                }
            }
        },
        other_charges: {
            validators: {
                stringLength: {
                    min: 0,
                    max: 100,
                    message: '不能超过 100 个字符',
                }
            }
        },
        payable_amount: {
            validators: {
                regexp: {
                    regexp: /^[0-9]+(\.[0-9]{1,2})?$/,
                    message: '请输入正确的金额'
                }, 
                stringLength: {
                    min: 0,
                    max: 20,
                    message: '不能超过 20 个字符',
                },
                notEmpty:{
					message:'不可以为空'
				}
            }
        },

    },
})
.on('success.form.bv', function(e) {
    e.preventDefault();
    var postData = $('form').serialize();
    $.post("/settle/customerfreight/save", postData, function(result) {
        if (result.code == 1) {
            parent.layer.msg(result.msg, {time: 2000}, function(){
            	var dataForMessage={
            			id:null,
            			pages:'customerSettle',
            			tips:'1',
            	}
            	websocket.send(JSON.stringify(dataForMessage));
                layer_close();
                parent.parent.refresh_iframe();
                
                // 通知相关页面刷新
                var msg = {
                        receiver: "customer_settled",
                        action: "refresh"
                }
                send(JSON.stringify(msg));
                
                msg.receiver = "sales";
                send(JSON.stringify(msg));
            });
        } else {
            parent.layer.msg(result.msg, {time: 2000});
        }
    });

});

//WebSocket
var websocket = null;
//判断当前浏览器是否支持WebSocket
if ('WebSocket' in window) {
  //websocket = new WebSocket("ws://"+ window.location.host +"/websocket");
	websocket = new WebSocket("ws://localhost:8080/websocket");
}
else {
  alert('当前浏览器 Not support websocket')
}

//连接发生错误的回调方法
websocket.onerror = function () {
};

//连接成功建立的回调方法
websocket.onopen = function () {
  //TODO用户登录系统检查属于自己的提醒消息
}

//接收到消息的回调方法
websocket.onmessage = function (event) {
    var msg = JSON.parse(event.data);
    if(msg.receiver === "customer_freight_edit") {
        if (msg.action === "refresh") {
            refresh();
        }
    }
}

//连接关闭的回调方法
websocket.onclose = function () {
}

//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
window.onbeforeunload = function () {
  closeWebSocket();
}

//关闭WebSocket连接
function closeWebSocket() {
  websocket.close();
}

// 刷新页面
function refresh() {
    $('#tb_departments').bootstrapTable('refresh');
}

//发送消息
function send(msg) {
    websocket.send(msg);
}

</script>
</body>
</html>